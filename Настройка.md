# Настройка контроллера
Настройку контроллера осуществляется по Bluetooth. Для настройки необходим телефон на Android или ПК на Windows 10/11 с поддержкой Bluetooth 4.0 и выше со стандартом Bluetooth Low Energy.  
Взаимодействие с контроллером осуществляется за счёт отправки текстовых команд и значений через BLE терминал.  
## Приложение для настройки
Для **Windows** использектся приложение ПППП.  
Для **Android** используется приложени реализующее BLE Терминал. Наиболее удобное [BLE Terminal](https://play.google.com/store/apps/details?id=com.mightyit.gops.bleterminal&hl=en).  
![https://play-lh.googleusercontent.com/O1mO9XYyjQ4TrmOPRTM3-WubYtCqBBFmBXj8D_fA1VSdh1qCv_stl5rhEOQ8tbRjG76D=w480-h960-rw](https://play-lh.googleusercontent.com/O1mO9XYyjQ4TrmOPRTM3-WubYtCqBBFmBXj8D_fA1VSdh1qCv_stl5rhEOQ8tbRjG76D=s128-rw)  
Для **iPhone** работа с iPhone также возможначерез стандартное приложение BLE терминала, однако работа с iPhone не тестировалась и данный вариант не рекомендуется на данный момент.  
## Подключение по Bluetooth
При подключении к контроллеру, он должен быть подключен к батарее и замок зажигания должен быть включен.  
Подключение в **Windows** происходит автоматически.  
На **Android** приложению необходимо дать разрешение на поиск устройств по близости. Затем в приложении найти устройство с названием вида `ImpESC_xxxx` и подключиться к нему.  
## Команды
Для чтения и запись параметров используются текстовые команды.  
Так, например, что бы узнать версию прошивки нужно ввести команду `version`,  в ответ придёт версия прошивки `Version 3.144`.  
Что бы записать значение, нужно после команды через пробел добавить значение. Например, команда `pole_pairs 4` установит количество пар полюсов магнитов мотора равным 4. В случаи корректно введённой команды, в ответ придёт подтвержение с теущим значением числа пар полюсов.  
Если команда была введена с ошибкой, в ответ придёт сообщение `wrong command`.  
При изменее параметра, он сразу применяется, но после выключения он не сохраниться. Для сохранения используется [команда `save`](##Сохранение-параметров).  
Список всех доступных команд доступен в разделе [Команды](Команды.md).
## Первое включение
После подключение всех проводов к контроллеру необходимо провести настройку.  
Первичная настройка состоит из следующих этапов:
- Настройка мотора
- Настройка ручки газа
- Настройка ограничений тока

После проходения всех этапов настройки, параметры необходимо сохранить и перезапустить контроллер.  
Во время первой поездки, в течении 10минут контроллер оптимизирует свои параметры. Если результат работы вас устроит, нужно будет произвести повторное сохранение.  
Ниже каждый этап расписан более подробно.
## Настройка мотора
### Когда нужна настройка мотора
Настройка мотора обязательно выполняется при первом включении, либо если вы подключие контроллер к другому мотору.  
Во время настройки контроллер тчательно оптимизирует свои параметры под конкретный мотор, он определяет точное положение датчиков Холла, электромеханические параметры двигателя. Если вы меняете двигатель на другой такойже модели, настройку всёравно необходимо будет повторить.  
### Подготовка
Для настройки необходимо установить самокат/велосипед на устойчевую подставку и вывесить приводное колесо. Во время настройки мотор будет вращаться вплоть до максимальной скорости.
### Настройка
Настройка мотора происходит в автоматическом режиме. Для запуска настройки необходимо ввести команду `calib_motor 50`. Цифра 50 в данной команде обозначает мощность тепла в ваттах, которая будет выделяться в моторе во время выполнения обучения Холлов. Для мальких моторов достаточно указать 50Вт, для крупных мотор колёс прмямого привода может потребоваться 100 или даже 150Вт. Рекомендуется начинать с 50Вт и если на первом этапе настройики вращение будет неравномерным, перзезапустить настройку с большим значеним. Осторожно, указанная мощность уходит в тепло, большие значения могут поджарить мотор.  
### Перезапуск настройки
Для перезапуска настройки необходимо выключить и включить питание ключом зажигания.  
### Направление вращения
Если в начале обучения колесо крутится в направлении движения назад, нужно перезагрузить контроллер и поменять направление вращениея командой `rot_invert 1`, после чего заново запустить обучение.
### Процесс обучения
Процесс обучения длится около 6 минут. Первую минуту мотор медленно вращается в прямом направление, вторую в обратном. После, в течении 4х минут, мотор плавно набирает скорость, в процессе чего контроллер подбирает динамические параметры мотора.
## Настройка ручки газа
## Настройка ограничений
## Сохранение параметров
Для сохранения текущих параметров необходимо ввести команду `save`, после чего необходимо перезапустить контроллер ключём зажигания.  
Что бы сбросить контроллер к заводским настройкам необходимо ввести команду `save_clear`.

